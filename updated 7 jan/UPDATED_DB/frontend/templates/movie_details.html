<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../static/css/movie_details.css">
    <meta charset="UTF-8">
    <title>Movie Details</title>

    <script>
        // Login Protection
        if (localStorage.getItem("isLoggedIn") !== "true") {
            window.location.href = "../templates/login.html";
        }
    </script>
</head>

<body>

<div class="navbar">
    <img class="website_logo" src="../static/media/images/website_logo.png"
         onclick="location.href='homepage.html'" style="cursor:pointer">

    <div class="f2">
        <div class="f2-left">
            <img class="bms_logo" src="../static/media/images/bmsce_logo.jpeg">
            <h1 class="bmsce">BMSCE</h1>
        </div>

        <div class="buttons">
            <form action="../templates/trendrec.html">
                <button class="navigation" type="submit">TRENDING</button>
            </form>

            <form action="../templates/trendrec.html">
                <button class="rate" type="submit">RECENT</button>
            </form>

            <form action="../templates/genre.html">
                <button class="navigation" type="submit">WATCHLIST</button>
            </form>

            <button id="logoutBtn" class="rate">LOGOUT</button>
            <h3 id="hellousername" class="user-greeting" style="color:white;margin-left:10px;"></h3>
        </div>
    </div>
</div>

<div class="main-container" id="details-content">
    <h2>Loading‚Ä¶</h2>
</div>

<script>
const API_BASE = `${location.protocol}//${location.hostname}:8000`;
const movieId = new URLSearchParams(location.search).get("id");
const userId = localStorage.getItem("user_id");

const img = (path, size="w500") =>
    path ? `https://image.tmdb.org/t/p/${size}${path}` : "../static/media/images/default_movie.png";

async function loadMovie() {
    try {
        // 1. Fetch TMDB Details
        const res = await fetch(`${API_BASE}/movie/details/${movieId}`, { credentials: "include" });
        if (!res.ok) throw new Error(res.status);
        const d = await res.json();

        // 2. Fetch User's Specific Rating from your Database
        let userRatingHtml = "";
        try {
            const ratingRes = await fetch(`${API_BASE}/movie/user-rating/${userId}/${movieId}`);
            const ratingData = await ratingRes.json();
            
            if (ratingData.rating) {
                userRatingHtml = `
                    <div class="metric-card" style="border: 1px solid #22c55e;">
                        <div class="m-label">User's Rating</div>
                        <div class="m-value">‚≠ê ${ratingData.rating}</div>
                    </div>
                `;
            }
        } catch (err) {
            console.error("Could not load user rating", err);
        }

        const crew = d.credits?.crew || [];
        const cast = d.credits?.cast || [];

        const directors = crew.filter(c => c.job === "Director").map(c => c.name).join(", ") || "N/A";
        const writers = crew.filter(c => c.department === "Writing").map(c => c.name).slice(0,3).join(", ") || "N/A";

        // 3. Render ALL sections back into the page
        document.getElementById("details-content").innerHTML = `
        <div class="hero">
            <img class="poster" src="${img(d.poster_path)}">
            <div>
                <h1>${d.title}</h1>
                <p style="color:var(--accent-blue); font-style:italic">${d.tagline || ""}</p>

                <div class="metrics">
                    <div class="metric-card">
                        <div class="m-label">TMDB Rating</div>
                        <div class="m-value">‚≠ê ${d.vote_average.toFixed(1)} (${d.vote_count})</div>
                    </div>
                    
                    ${userRatingHtml}

                    <div class="metric-card">
                        <div class="m-label">Runtime</div>
                        <div class="m-value">${d.runtime} min</div>
                    </div>
                    <div class="metric-card">
                        <div class="m-label">Release</div>
                        <div class="m-value">${d.release_date}</div>
                    </div>
                </div>

                <p><b>Genres:</b> ${d.genres.map(g=>g.name).join(", ")}</p>
                <p><b>Director:</b> ${directors}</p>
                <p><b>Writer:</b> ${writers}</p>
                
                <button class="rateBtn" id="rateBtn" style="margin-top:20px;">RATE MOVIE</button>

                ${d.external_ids?.imdb_id ? `<p><b>IMDb:</b> <a target="_blank" href="https://www.imdb.com/title/${d.external_ids.imdb_id}">${d.external_ids.imdb_id}</a></p>` : ""}
            </div>
        </div>

        <div class="section">
            <h2>Overview</h2>
            <p>${d.overview}</p>
        </div>

        <div class="section">
            <h2>üé≠ Cast</h2>
            <div class="cast-grid">
                ${cast.slice(0,18).map(a=>`
                    <div class="actor-card">
                        <img class="actor-img" src="${img(a.profile_path,'w185')}">
                        <b>${a.name}</b><br>
                        <span style="color:var(--accent-blue)">${a.character}</span>
                    </div>
                `).join("")}
            </div>
        </div>

        <div class="section">
            <h2>üé• Trailers</h2>
            ${d.videos.results.filter(v=>v.site==="YouTube").slice(0,2).map(v=>`
                <iframe width="100%" height="450" src="https://www.youtube.com/embed/${v.key}" allowfullscreen style="margin-bottom:10px; border-radius:10px;"></iframe>
                <p>${v.name}</p>
            `).join("") || "<p>No videos available.</p>"}
        </div>

        <div class="section">
            <h2>üì∫ Watch Providers</h2>
            ${Object.entries(d["watch/providers"].results || {}).map(([c,p])=>`
                <div class="box" style="margin-bottom:10px; border: 1px solid #444; padding: 10px; border-radius: 8px;">
                    <b>${c}</b><br>
                    ${p.flatrate?.map(f=>`
                        <img width="40" src="${img(f.logo_path,'w92')}" style="border-radius:5px; margin-right:5px;"> ${f.provider_name}
                    `).join("") || "No streaming info"}
                </div>
            `).join("") || "<p>No providers listed.</p>"}
        </div>

        <div class="section">
            <h2>üìù Reviews</h2>
            ${d.reviews.results.slice(0,3).map(r=>`
                <div class="box" style="border-bottom: 1px solid #444; padding: 15px 0;">
                    <b>${r.author}</b>
                    <p style="font-size:0.9em; opacity:0.8;">${r.content.slice(0,500)}‚Ä¶</p>
                </div>
            `).join("") || "<p>No reviews yet.</p>"}
        </div>
        `;

        // Attach listener to the newly rendered button
        document.getElementById("rateBtn").addEventListener("click", () => {
            window.location.href = `rating.html?id=${movieId}`;
        });

    } catch (err) {
        console.error(err);
        document.getElementById("details-content").innerHTML = "<h2>Failed to load movie.</h2>";
    }
}

loadMovie();
</script>

<script>
    // Navbar Greeting and Logout Logic
    const loggedInUsername = localStorage.getItem("username");
    const helloEl = document.getElementById("hellousername");

    if (loggedInUsername && helloEl) {
        helloEl.innerText = `Hello, ${loggedInUsername}!`;
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "login.html";
    });
</script>

</body>
</html>